# perp-dex-tools 功能说明

## 系统概览

`perp-dex-tools` 是一个面向多家永续合约交易所的自动化刷量与低磨损交易框架。系统基于 Python 异步事件循环构建，通过一套统一的交易核心驱动多交易所适配器完成下单、成交监控、风险控制和通知告警。整体特点包括：

- 统一命令行入口，参数化配置策略行为。
- 模块化交易核心，负责循环下单、平仓、节奏控制、风控与日志。
- 可扩展的交易所适配层，实现不同交易所 SDK/WebSocket/REST 交互。
- 日志、CSV 订单回放、Telegram / 飞书通知等辅助能力。

下文将按模块拆解系统功能，以便快速理解代码实现与扩展方式。

## 核心模块

### 命令行入口 `runbot.py`

- 解析命令行参数（交易所、标的、数量、止盈、方向、最大挂单数、冷却时间、网格步长、停止/暂停价格、Boost 模式等）。
- 验证 Boost 模式仅限 `aster` 与 `backpack` 交易所使用。
- 加载指定的 `.env` 文件并注入环境变量。
- 构造 `TradingConfig` 数据类作为策略运行时配置。
- 创建 `TradingBot` 实例并通过 `asyncio.run` 执行主循环，负责捕获顶层异常和退出码控制。

### 交易核心 `trading_bot.py`

#### `TradingConfig`

- 描述所有策略参数，并提供 `close_order_side` 便捷属性用于推导平仓方向。

#### `TradingBot`

- 构造阶段创建统一的 `TradingLogger`、交易所客户端以及订单事件同步对象。
- `_setup_websocket_handlers` 注册订单更新回调，桥接各交易所的实时推送。
- `run()` 为主协程，职责包括：
  1. 调用交易所接口获取合约标识与最小变动价。
  2. 输出配置信息并建立 WebSocket/REST 连接。
  3. 进入主循环：
     - 刷新当前平仓挂单列表与仓位信息。
     - 每分钟输出状态，并校验仓位与挂单数量是否失衡；失衡时触发告警与优雅停机。
     - 根据 `stop_price` / `pause_price` 判断是否停止或暂缓交易。
     - 根据活跃平仓单数量与 `max_orders` 计算动态冷却时间（`_calculate_wait_time`）。
     - 根据 `grid_step` 判断新单平仓价与现有平仓单的最小距离要求（`_meet_grid_step_condition`）。
     - 若条件满足则调用 `_place_and_monitor_open_order` 完成一次“开仓→监控→平仓单”流程。
- `_place_and_monitor_open_order`
  - 以当前盘口为基准下限价开仓单，并等待 WebSocket 事件或轮询状态判定是否成交。
  - Boost 模式下成交即发市价单平仓；普通模式按止盈百分比计算目标价格后下挂单。
  - 未完全成交时执行撤单重试与部分成交处理。
- `_log_status_periodically` 汇总仓位、挂单、成交量，写入日志并与 CSV 对账数据对齐。
- `_check_price_condition` 实现止停价逻辑；`_meet_grid_step_condition` 实现网格稀疏控制。
- `send_notification` 同时支持飞书和 Telegram 推送。
- `graceful_shutdown` 统一执行资源释放、断开交易所连接。

### 交易所适配层 `exchanges`

#### `BaseExchangeClient`

- 定义所有交易所客户端需实现的抽象接口：连接、断开、下单、撤单、订单查询、仓位查询、盘口获取等。
- 提供 `round_to_tick` 用于按最小价格单位对齐报价。
- 内置 `query_retry` 装饰器封装基于 `tenacity` 的指数退避重试逻辑。

#### `ExchangeFactory`

- 维护交易所名称与实现类路径的映射，通过惰性导入加载具体客户端。
- 提供 `get_supported_exchanges()` 用于 CLI 参数校验；`register_exchange()` 便于外部动态扩展。

#### 交易所实现概览

- **EdgeX (`edgex.py`)**：使用官方 `edgex_sdk`；提供私有 WebSocket 自动重连；下单接口内置 post-only 重试、盘口获取、仓位同步；对关闭单进行价格微调以保持 maker 角色。
- **Backpack (`backpack.py`)**：结合官方 `bpx` SDK 与自建 WebSocket 管理器；支持 ED25519 签名登录；提供市价单接口用于 Boost 模式闭环；处理多种订单事件（接受、成交、撤单、过期）。
- **Paradex / Aster / GRVT / Lighter**：分别封装各自 SDK/API 规范，统一适配 `BaseExchangeClient` 接口。这里包括 websocket 重连策略、定制化撤单等待、盘口异常处理、合约元数据解析等逻辑。
- 新交易所的接入步骤可参考 `docs/ADDING_EXCHANGES.md`。

### 助手模块 `helpers`

- `logger.TradingLogger`：
  - 在 `logs/` 目录生成 CSV 订单流水与调试日志文件，支持按 `ACCOUNT_NAME` 区分多账户。
  - Console 输出可选，时间戳自动切换指定时区（默认上海）。
- `telegram_bot.TelegramBot`：基于 `requests` 发送消息，内置 TLS 校验与上下文管理。
- `lark_bot.LarkBot`：基于 `aiohttp` 的飞书机器人封装，提供异步消息推送。
- `helpers/__init__.py` 汇总导出工具，方便集中引用。

### 测试模块 `tests`

- `test_query_retry.py` 覆盖 `query_retry` 装饰器的重试与兜底行为，确保网络请求失败时能安全退回。

## 运行流程概述

1. 用户在命令行执行 `python runbot.py [参数]`。
2. `runbot.py` 解析参数、加载环境变量、实例化配置与交易机器人。
3. `TradingBot.run()` 建立交易所连接并进入主循环：
   - 定时拉取活跃订单与仓位，维持本地状态。
   - 动态判断冷却、网格、止停价条件。
   - 满足条件后触发下单逻辑，依据成交反馈更新状态并下平仓单。
   - 写入日志与 CSV，同时根据异常情况触发告警或停机。
4. 程序退出前调用 `graceful_shutdown`，确保断开 WebSocket/REST 连接并释放资源。

## 功能特性一览

- **多交易所支持**：EdgeX、Backpack、Paradex、Aster、Lighter、GRVT 已完成适配；统一参数与策略逻辑。
- **动态节奏控制**：依据活跃平仓单占比自动调整冷却时间，防止过度开仓。
- **网格步长约束**：通过 `grid_step` 确保平仓单分布稀疏，提升成交效率。
- **止停价 / 暂停价**：在价格触发阈值时自动停止或暂停下单，降低行情突变风险。
- **Boost 模式**：针对 `backpack`、`aster` 提供“挂限价开仓→即时市价平仓”闭环，加速刷量。
- **持仓一致性校验**：检测实际仓位与平仓挂单数量的偏差，偏差过大时通知并停机以防风险扩大。
- **日志与追踪**：实时状态输出 + CSV 订单追踪 + 调试日志，便于回放与复盘。
- **通知集成**：支持飞书、Telegram 双通道告警，可在 `.env` 中按需启用。

## 配置与参数

### 环境变量

- 通用：`ACCOUNT_NAME`（多账户日志区分）、`TIMEZONE`、通知类 `TELEGRAM_BOT_TOKEN`、`TELEGRAM_CHAT_ID`、`LARK_TOKEN`。
- EdgeX：`EDGEX_ACCOUNT_ID`、`EDGEX_STARK_PRIVATE_KEY`、`EDGEX_BASE_URL`、`EDGEX_WS_URL`。
- Backpack：`BACKPACK_PUBLIC_KEY`、`BACKPACK_SECRET_KEY`。
- Paradex：`PARADEX_L1_ADDRESS`、`PARADEX_L2_PRIVATE_KEY` 等。
- Aster：`ASTER_API_KEY`、`ASTER_SECRET_KEY`。
- Lighter：`API_KEY_PRIVATE_KEY`、`LIGHTER_ACCOUNT_INDEX`、`LIGHTER_API_KEY_INDEX`。
- GRVT：`GRVT_TRADING_ACCOUNT_ID`、`GRVT_PRIVATE_KEY`、`GRVT_API_KEY`。
- `.env` 样例见 `env_example.txt`，Paradex 依赖单独的 `para_env` 虚拟环境（`para_requirements.txt`）。

### 命令行参数（节选）

| 参数 | 说明 | 默认 |
| --- | --- | --- |
| `--exchange` | 选择交易所（`ExchangeFactory.get_supported_exchanges()`） | `edgex` |
| `--ticker` | 标的符号，例如 `ETH`、`BTC` | `ETH` |
| `--quantity` | 单次下单合约数（`Decimal`） | `0.1` |
| `--take-profit` | 止盈百分比（`0.02` = 0.02%） | `0.02` |
| `--direction` | 交易方向 `buy/sell` | `buy` |
| `--max-orders` | 最大平仓挂单数量 | `40` |
| `--wait-time` | 冷却时间（秒） | `450` |
| `--grid-step` | 平仓单最小间距百分比，`-100` 表示关闭 | `-100` |
| `--stop-price` | 触发停止交易的价格阈值 | `-1` |
| `--pause-price` | 触发暂停交易的价格阈值 | `-1` |
| `--boost` | 启用 Boost 刷量模式（仅 `aster/backpack`） | `False` |

完整参数说明可结合 `README.md` 与源代码注释查看。

## 错误处理与恢复机制

- `query_retry` 装饰器：对指定 API 调用提供指数退避重试与失败回退值，避免瞬时网络故障导致异常中断。
- WebSocket 重连：如 EdgeX 私有流，使用后台任务维护连接并在断线时指数回退重连。
- 订单状态确认：下单后轮询或等待事件，在撤单/成交确认前阻塞流程，确保状态一致。
- 日志内的错误分级：`TradingLogger` 根据 `INFO/WARNING/ERROR` 分类，便于监控。
- 全局异常处理：`runbot.py` 捕获未处理异常并打印，同时 `TradingBot.run` 在 `finally` 中再次尝试断开连接以防资源泄漏。

## 扩展指南

- 参考 `docs/ADDING_EXCHANGES.md`：实现新的 `BaseExchangeClient` 子类，覆盖连接、下单、撤单、数据获取等方法。
- 在 `ExchangeFactory._registered_exchanges` 注册模块路径即可被 CLI 识别。
- 若需要自定义日志或告警渠道，可在 `helpers` 目录新增模块，并在 `TradingBot.send_notification` 中调用。

## 测试与验证

- `tests/test_query_retry.py` 验证重试装饰器在成功/失败场景下的行为，保证策略在网络异常时的健壮性。
- 建议在部署前结合实际交易所的沙盒或小额资金进行回归测试，以验证 API 配置与下单流程。

## 数据持久与可观测性

- `logs/<exchange>_<ticker>[_<ACCOUNT_NAME>]_{orders.csv, activity.log}`：
  - `orders.csv` 记录时间戳、订单号、方向、数量、价格、状态。
  - `activity.log` 记录运行时事件、错误、告警。
- 控制台定期输出包含仓位、活跃平仓单数量的状态摘要。

## 总结

本仓库提供了一个可扩展的多交易所自动交易框架。通过清晰的模块划分、统一的接口约束、完善的日志与告警机制，开发者可以快速适配新的交易所或策略变体，并在高频下单场景中保证基本的风险控制与可观测性。若需构建自定义功能（例如额外指标过滤、仓位管理策略），可在 `TradingBot` 主循环内扩展逻辑或在交易所客户端中新增能力。